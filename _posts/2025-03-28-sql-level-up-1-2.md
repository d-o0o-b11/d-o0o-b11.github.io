---
title: 1장 (3-완강)
description: 
# author: d_o0o_b
categories: [Reading, SQL-Level-Up]
tags: [typography]
# pin: true
math: true
mermaid: true
---

## 3강: DBMS와 실행 계획

### 데이터 접근 방법은 어떻게 결정될까?

RDBMS에서 데이터에 접근하는 방법을 결정하는 모듈은 쿼리 평가 엔진이다. 이 엔진은 사용자로부터 입력받은 SQL 구문(쿼리)을 처음 읽어들이는 역할을 한다. 쿼리 평가 엔진은 여러 서브 모듈로 구성되며 주요 서브 모듈은 **파서(Parser)**와 **옵티마이저(Optimizer)**이다.

1. 파서 (parser)
    - 역할: SQL 구문을 구문 분석(파싱)하는 단계
    - 사용자가 작성한 SQL이 문법적으로 올바른지 확인하고 구문 오류를 잡아낸다. 예를 들어, 쉼표를 빼먹거나 존재하지 않는 테이블 이름을 사용할 때 이를 감지한다.
    - SQL 구문을 정형화된 형식으로 변환하여 DBMS가 후속 처리를 효율적으로 할 수 있도록 돕는다.

2. 옵티마이저 (optimizer)
    - 역할: SQL 구문을 최적화하여 실행 계획을 선택하는 단계
    - 옵티마이저는 여러 데이터 접근 방법(실행 계획)을 고려하고 각 접근 방법의 비용을 계산한 후, 가장 효율적인 계획을 선택한다.
    - 최적화 대상은 인덱스 유무, 데이터 분포도, DBMS 내부 설정 등이다.
    - 여러 실행 계획을 비교하고 선택하는 일이 번거롭기 때문에 RDBMS는 이를 자동화하여 비용이 적은 실행 계획을 선택한다.

3. 카탈로그 매니저 (catalog manager)
    - 역할: 옵티마이저가 실행 계획을 세울 때 필요한 통계 정보 제공
    - 카탈로그는 DBMS 내부의 테이블 정보, 인덱스 정보, 통계 정보 등을 포함한다. 이 정보는 옵티마이저가 실행 계획을 최적화하는 데 중요한 역할을 한다.

4. 플랜 평가 (plan evaluation)
    - 역할: 옵티마이저가 생성한 실행 계획 중에서 최적의 계획을 선택하는 단계
    - 실행 계획은 DBMS가 바로 실행할 수 있는 코드가 아니라 사람이 읽을 수 있는 '계획서' 형태이다.
    - 이 계획을 통해 성능이 좋지 않은 SQL 구문을 분석하고 개선할 방법을 고려할 수 있다.

### 옵티마이저와 통계 정보
DBMS에서 쿼리가 실행될 때, 옵티마이저가 최적의 실행 계획을 선택하지만 이 과정에서 중요한 역할을 하는 것이 통계 정보이다. 옵티마이저는 카탈로그 매니저가 관리하는 통계 정보를 기반으로 실행 계획을 세우므로 데이터베이스 사용자나 엔지니어는 이 정보를 잘 관리해야 한다. 옵티마이저가 항상 최적의 계획을 선택하는 것은 아니기 때문에 통계 정보의 정확성과 최신성이 중요하다.

#### 옵티마이저의 한계
옵티마이저가 실행 계획을 선택할 때 통계 정보가 부족하거나 오래된 경우 최적의 실행 계획을 선택하지 못할 수 있다. 옵티마이저는 카탈로그에 저장된 통계 정보를 바탕으로 계획을 세우는데 통계 정보가 실제 데이터와 맞지 않으면 오류를 일으킬 수 있다. 예를 들어, 데이터가 삽입, 갱신, 삭제되었는데도 카탈로그의 통계 정보가 갱신되지 않으면 옵티마이저는 오래된 데이터를 바탕으로 잘못된 실행 계획을 생성할 수 있다.

#### 카탈로그에 포함된 통계 정보
카탈로그는 데이터베이스 내부의 통계 정보를 관리하며 그 정보는 다음과 같다.
- 각 테이블의 레코드 수
- 각 테이블의 필드 수와 크기
- 필드의 카디널리티(값의 개수)
- 필드값의 히스토그램(값의 분포)
- NULL값의 수
- 인덱스 정보

이 통계 정보를 활용하여 옵티마이저는 최적의 실행 계획을 만든다. 그러나 카탈로그 정보가 실제 데이터와 일치하지 않으면 옵티마이저는 잘못된 결정을 내릴 수 있다.

### 최적의 실행 계획을 작성하려면?
최적의 실행 계획을 만들기 위해서는 올바른 통계 정보가 매우 중요하다. 테이블에 데이터 삽입, 갱신, 삭제가 빈번하게 이루어지면 카탈로그의 통계 정보도 주기적으로 갱신해야 한다. 통계 정보 갱신은 테이블이나 인덱스의 크기와 수에 따라 몇십 분에서 몇 시간이 걸릴 수 있어 실행 비용이 높은 작업이지만, 최적의 실행 계획을 선택하기 위해서는 반드시 필요한 작업이다.

따라서 통계 정보 갱신 시점을 신중하게 검토해야 하며, 이를 관리하는 것이 SQL 성능 최적화의 핵심이다.


## 4강: 실행 계획이 SQL 구문의 성능을 결정
SQL 구문의 실행 계획이 결정되면 DBMS는 이를 기반으로 데이터 접근을 수행한다. 하지만 데이터 양이 많은 테이블을 조회하거나 복잡한 SQL 구문을 실행하면 반응 속도가 느려질 수 있다.

이러한 성능 저하의 원인 중 하나는 통계 정보 부족이다. 하지만 통계 정보가 충분하더라도 실행이 느릴 수 있으며, 최신 통계 정보를 가지고 있어도 SQL 구문이 지나치게 복잡하면 옵티마이저가 최적의 접근 경로를 선택하지 못할 수도 있다.

SQL 구문의 실행 속도가 느려진다면 가장 먼저 실행 계획을 확인해야 한다. 모든 DBMS는 실행 계획을 조사할 수 있는 방법을 제공하며, 대부분 명령행 인터페이스에서 이를 확인할 수 있다.

### PostgreSQL에서 실행 계획 확인하기
PostgreSQL에서는 EXPLAIN 명령어를 사용하여 SQL 구문의 실행 계획을 확인할 수 있다. EXPLAIN을 활용하면 쿼리가 어떻게 실행될지, 어떤 방식으로 데이터를 검색하는지 등을 분석할 수 있다. 이를 통해 성능 개선이 필요한 부분을 파악하고 적절한 튜닝을 진행할 수 있다.

> 실습 내용을 참고하기
{: .prompt-info }


## 5강: 실행 계획의 중요성
최근의 옵티마이저는 성능이 우수하지만 완벽하지는 않다. 옵티마이저가 최적이라고 판단한 실행 계획이 실제로는 성능 저하를 초래할 수도 있으며, 옵티마이저가 적절한 정보를 받지 못해 비효율적인 실행 계획을 선택하는 경우도 있다.

예를 들어, 인덱스를 사용하면 성능이 향상될 구문에서 인덱스를 사용하지 않거나, 테이블 결합 순서를 비효율적으로 지정하는 등의 문제가 발생할 수 있다. 이러한 경우에는 실행 계획을 수동으로 변경하는 것이 필요하다.

### 실행 계획을 수동으로 변경하는 방법
일부 DBMS에서는 옵티마이저에게 특정 실행 계획을 따르도록 강제하는 힌트 구(Hint) 기능을 제공한다. 예를 들어, Oracle과 MySQL에서는 힌트를 활용하여 실행 계획을 조정할 수 있다. 하지만 DB2와 같은 일부 DBMS는 힌트 구 기능을 제공하지 않는다.

힌트 구 기능이 없다면, SQL 구조 변경, 테이블 설정 변경, 또는 애플리케이션 코드 수정과 같은 복잡한 대응이 필요할 수도 있다. 따라서 실행 계획을 변경하기 위해서는 가능한 선택지를 충분히 이해하고 있어야 한다.

### 실행 계획 최적화를 위한 기본 원칙
1. SQL 구문의 접근 경로 이해
    - 옵티마이저가 데이터를 어떻게 검색하는지 파악해야 한다.

2. 효율적인 테이블 설정
    - 인덱스 활용, 테이블 구조 최적화 등을 고려해야 한다.

3. 실행 계획 예측 능력 향상
    - 특정 SQL 구문이 어떤 실행 계획을 생성할지 미리 예상할 수 있어야 한다.

이러한 요소들은 관계형 데이터베이스의 이상적인 목표인 물리 계층 은폐와는 상반될 수 있지만, 현실적인 성능 최적화를 위해 반드시 고려해야 한다.