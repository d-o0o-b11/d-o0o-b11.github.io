---
title: Node.js 아키텍처 - [2]
description: 흐름도
# author: d_o0o_b
categories: [Dev-Notes, Theory]
tags: [typography]
# pin: true
math: true
mermaid: true
---

## 한 줄 정리

Node.js는 V8 JavaScript 엔진을 기반으로 JavaScript 코드를 실행하는 오픈소스 크로스 플랫폼 서버 환경입니다.

## 요약

Node.js는 JavaScript 실행을 위한 런타임 환경으로 Google의 V8 엔진을 사용하여 JavaScript 코드를 빠르게 처리합니다. 또한, 이벤트 루프와 운영체제의 시스템 API와의 연계를 위해 libuv 라이브러리를 활용합니다. 이를 통해 비동기 I/O 처리가 가능하며, 높은 성능과 확장성을 제공합니다.


## 아키텍처

![Image](https://github.com/user-attachments/assets/db41ee9e-0ea9-4e7b-98a8-c08cbe13d804?raw=true)


### 1️⃣ 요청 발생 및 코드 변환
애플리케이션에서 요청이 발생하면 V8 엔진이 JavaScript 코드로 작성된 요청을 바이트 코드 또는 기계어로 변환하여 실행합니다. V8 엔진의 최적화된 컴파일링 기술 덕분에 실행 속도가 매우 빠릅니다.

### 2️⃣ Node.js API 실행
Node.js는 파일 시스템, 네트워크, 데이터베이스 등의 기능을 제공하는 API를 내장하고 있습니다. 이러한 API는 JavaScript로 제공되지만 내부적으로는 C++로 구현되어 있으며 더 낮은 수준의 시스템 API와 직접 상호작용합니다.

### 3️⃣ 이벤트 큐 등록
Node.js는 libuv 라이브러리를 활용하여 이벤트 루프를 관리합니다. 애플리케이션에서 발생한 요청은 libuv 내부의 이벤트 큐에 추가되며,이후 이벤트 루프가 이를 처리합니다.

### 4️⃣ 비동기 처리
이벤트 큐에 저장된 요청은 이벤트 루프를 통해 운영체제 커널로 전달됩니다. 
운영체제가 비동기 처리를 직접 수행할 수 있는 경우, 커널이 작업을 처리한 후 결과를 이벤트 루프로 다시 반환합니다. 그러나 데이터베이스 액세스, DNS 조회, 파일 처리 등과 같이 운영체제에서 직접 비동기 처리가 어려운 작업은 libuv의 워커 스레드 풀을 활용하여 처리합니다.

### 5️⃣ 처리 결과 반환
운영체제 커널 또는 워커 스레드가 완료한 작업 결과는 다시 이벤트 루프로 전달됩니다. 이벤트 루프는 해당 요청의 콜백 함수를 실행하여 작업이 완료되었음을 알립니다.

### 6️⃣ 이벤트 루프의 완료 처리
이벤트 루프는 완료된 요청을 확인한 후 등록된 콜백 함수를 실행하여 최종 처리를 진행합니다.

### 7️⃣ 애플리케이션으로 응답 전달
이벤트 루프에서 처리된 응답 데이터를 Node.js 애플리케이션으로 전달하여, 클라이언트에게 최종 결과를 반환합니다.


## 추가 정보

### I/O 작업과 일반 작업의 처리 방식
- I/O 작업이 아닌 경우(즉, CPU 연산 등 일반적인 동기 실행 코드)
  - JavaScript의 콜 스택(Node.js 애플리케이션 안) 에서 즉시 실행됩니다.
  - ex. `const result = 1 + 2;`, `console.log("Hello")` 같은 일반적인 연산

- I/O 작업(파일 시스템, 네트워크 요청, DB 조회 등)인 경우
  - libuv를 통해 이벤트 루프와 비동기 처리 시스템을 활용합니다.
  - 비동기 처리가 가능한 경우 운영체제의 커널이 직접 처리하고 
  - 비동기 처리가 어려운 작업(DB 조회, 파일 I/O 등)은 **Worker Threads**를 사용하여 처리합니다.

즉, I/O 작업은 libuv를 통해 이벤트 루프에서 관리되지만 단순한 연산 작업은 이벤트 루프를 거치지 않고 콜 스택에서 바로 실행됩니다.


### Node.js는 싱글 스레드인데 워커 스레드가 있으면 싱글 스레드가 맞는건가?
Node.js는 기본적으로 싱글 스레드로 동작하지만, 워커 스레드를 통해 멀티 스레드 환경을 지원할 수 있습니다.

기본적으로 Node.js는 이벤트 루프와 콜 스택을 사용하여 비동기 작업을 처리하는 싱글 스레드 모델을 따릅니다. 이는 I/O 작업이나 비동기 작업을 처리할 때 효율적인 성능을 보장하지만, CPU 집약적인 작업에서는 한계가 있을 수 있습니다.

#### 워커 스레드란?
- Node.js v12에서 도입되었으며 이를 사용하면 멀티 스레드 환경에서 CPU 집약적인 작업을 병렬로 처리할 수 있습니다.
- 기본적인 싱글 스레드의 이벤트 루프와는 별개로 독립적인 스레드에서 실행되어 CPU 작업을 분리하여 처리합니다.
- 이렇게 함으로써 기본 스레드의 부담을 덜어주고 비동기 작업과 I/O 작업은 그대로 효율적으로 처리하면서 CPU 작업을 병렬로 처리할 수 있습니다.


### Node.js는 이벤트 기반 비동기 프로그래밍을 제공합니다.
Node.js는 이벤트 기반 아키텍처를 가지고 있습니다. 즉, 여러 작업을 순차적으로 처리하는 것이 아니라 이벤트 루프와 콜백을 통해 비동기적으로 처리합니다. 비동기 작업은 **이벤트 루프**와 **이벤트 큐**에서 처리되며 이를 통해 높은 처리 성능을 유지할 수 있습니다.

하지만 **동기 작업(Synchronous task)**은 콜 스택에서 즉시 처리됩니다. 이러한 작업은 이벤트 루프와 별개로 실행되며 이벤트 루프에 영향을 미치지 않습니다. 동기 작업은 그 자체로 즉시 실행되며 완료된 후에야 이벤트 루프가 비동기 작업을 처리하게 됩니다.

#### 정리
1. 동기 I/O는 이벤트 루프를 거치지 않고 호출한 코드에서 즉시 실행됩니다.

2. 비동기 I/O는 **운영체제가 비동기 API를 지원하면** 커널이 처리하지만 **지원하지 않으면** libuv가 스레드 풀을 사용하여 비동기로 보이게 만듭니다.

3. libuv의 스레드 풀은 비동기 I/O를 지원하지 않는 환경에서 비동기처럼 작동하도록 하기 위해 사용됩니다.

