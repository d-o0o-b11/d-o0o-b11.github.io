---
title: 5장 정리 - (14강- 15강(1))
description: 반복문
# author: d_o0o_b
categories: [Reading, SQL-Level-Up]
tags: [typography]
# pin: true
math: true
mermaid: true
---

## 14강: 반복문 의존증

개발자라면 누구나 한 번쯤 겪는 병이 있다. 이름하여 "반복문 의존증"이다. 문제를 레코드 단위로 작게 나누고, 각 레코드에 반복문을 적용해 해결하려는 습관이다. 익숙한 절차형 언어에서 자연스럽게 생기는 이 습관은, SQL이라는 언어를 마주했을 때 큰 혼란을 준다.

### Q. 왜 SQL에는 반복문이 없는 건가요?
반복문 의존증에 걸린 사람은 SQL을 보면 반복문이 없다는 점에 당황한다. 그리고 "이런 언어로 뭘 할 수 있겠어?"라는 실망으로 이어지기도 한다. 그러나 SQL에는 처음부터 반복문이 없도록 설계되어 있다. 단순히 구현하지 않은 것이 아니라, 필요 없다고 판단했기 때문이다.

SQL의 근간이 되는 관계형 모델을 만든 Edgar F. Codd는 다음과 같이 말했다.

>관계 조작은 관계 전체를 모두 조작 대상으로 삼는다. 그 목적은 반복을 제외하는 것이다. 그래야 최종 사용자와 응용 프로그래머의 생산성이 높아진다.

즉, SQL은 관계 전체를 대상으로 한 고수준 추상화 언어이기 때문에 반복문이 불필요하다고 본 것이다. 그러나 현실은 그렇게 간단하지 않다. 많은 사용자들은 반복문 없이 문제를 해결하는 방법에 익숙하지 않다.

### 반복문이 없는 SQL, 현실에서의 대처

현실에서 반복문이 없는 SQL을 사용하다 보면, 많은 개발자들은 SQL은 최소한으로 쓰고, 비즈니스 로직은 호스트 언어(C#, Java 등)에서 구현하게 된다. 이렇게 하면 레코드를 하나씩 처리할 수 있기 때문에 익숙하다. 그러나 이런 방식은 결국 SQL을 "파일 다루듯" 사용하는 것으로, 반복계 코드가 만들어진다.

다음과 같은 방식들이 대표적인 반복계 처리 방식이다.
- 화면 출력을 위해 SELECT를 레코드 단위로 반복 호출
- 배치 처리를 위해 레코드를 하나씩 읽고 처리

사실 이런 코드를 작성한 경험은 대부분 있을 것이다. 필자 역시 마찬가지다.

그렇다면, 반복문을 쓰는 게 나쁜가? 아니다. 무조건 SQL로 처리해야 하는 것도 아니고, 반복문을 쓰는 것이 더 직관적일 수 있다. 또한 O/R Mapper나 미들웨어 같은 프레임워크 내부에서도 반복계 로직은 흔히 사용된다.

하지만 SQL이 반복문을 제외한 데는 단순한 생산성 외에도 중요한 장점이 존재한다. 바로 성능이다.



## 15강: 반복계의 공포
반복계의 장점은 명확하다. SQL에 익숙하지 않아도 쉽게 코드를 작성할 수 있다. 하지만 반복계에는 치명적인 단점이 있다. 바로 성능 저하이다.

### 반복계가 느린 이유
1. SQL 실행의 오버헤드
    반복계는 작은 SQL을 여러 번 실행한다. 이때 발생하는 파싱, 실행 계획 생성 등의 오버헤드는 결코 작지 않다. 특히 파싱은 SQL 실행마다 발생하며, 복잡한 경우 수백 ms에서 1초 이상 걸릴 수도 있다.

2. 병렬 처리가 어렵다
    반복계는 단순한 쿼리를 여러 번 호출하는 방식이므로 CPU 병렬 처리나 저장소의 병렬 I/O 활용이 어렵다. 반면, 포장계 SQL은 병렬 처리 최적화가 가능하다.

3. DBMS의 진화 혜택을 누릴 수 없다
    최근 DBMS는 대규모 데이터를 빠르게 처리하기 위한 고도화된 실행 계획 수립, SSD 기반 저장소 최적화 등을 포함한다. 하지만 반복계는 이런 최적화의 수혜를 받지 못한다. 단순한 SQL 반복은 애초에 튜닝 대상조차 되지 않기 때문이다.


### 반복계의 진짜 무서운 점
반복계는 단지 느린 것이 문제가 아니다. 튜닝 여지가 거의 없다는 점이 더 큰 문제다. 포장계 SQL은 복잡하지만 튜닝을 통해 수십 배의 성능 향상이 가능하다. 그러나 반복계는 튜닝으로 얻을 수 있는 개선 폭이 극히 적다. 이 점이 반복계를 무섭게 만든다.

## 정리
반복문 의존증은 익숙함에서 오는 병이다. SQL을 제대로 사용하기 위해서는 레코드 단위 반복이라는 절차형 사고를 벗어나, 집합과 관계를 다루는 선언형 사고로 전환할 필요가 있다.

물론 반복문이 필요할 때는 써야 한다. 하지만 성능, 유지보수성, 확장성을 생각할 때 반복계보다는 포장계로의 전환을 고민해야 한다. 그것이 결국 더 나은 시스템을 만드는 길이다.

