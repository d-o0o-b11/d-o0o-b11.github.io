---
title: HTTP , HTTPS 동작 원리 [4]
description: Session vs Cookie
# author: d_o0o_b
categories: [Dev-Notes, Theory]
tags: [typography]
# pin: true
math: true
mermaid: true
---

## 쿠키
HTTP 쿠키는 웹 서버가 사용자의 웹 브라우저에 전송하는 작은 데이터 조각입니다. 이 작은 데이터는 브라우저에 저장되며 이후 사용자가 같은 서버에 다시 요청할 때 그 데이터도 함께 전송됩니다. 쿠키는 서버가 클라이언트를 식별하거나 세션 유지, 사용자 행동 추적 등을 할 수 있게 도와주는 중요한 역할을 합니다.

HTTP 프로토콜은 기본적으로 상태가 없는(stateless) 프로토콜이기 때문에 서버는 클라이언트의 상태를 기억할 수 없습니다. 그런데 쿠키를 사용하면 서버가 클라이언트의 상태를 기억할 수 있게 되어 로그인 상태 유지, 장바구니 정보 저장 등의 기능을 제공할 수 있습니다.

### 쿠키 vs. Modern Storage APIs
과거에는 클라이언트 측에 데이터를 저장하는 방법으로 쿠키가 유일했지만, 오늘날에는 웹 스토리지 API(localStorage, sessionStorage)와 IndexedDB 같은 현대적인 저장 방법이 더 권장됩니다. 왜냐하면 쿠키는 매번 HTTP 요청에 포함되어 전송되기 때문에 성능 저하를 유발할 수 있습니다. 특히 모바일 데이터 연결에서는 네트워크 비용을 증가시키고 성능을 저하시킬 수 있습니다.

웹 스토리지 API는 쿠키와 달리 요청 시마다 데이터를 전송하지 않기 때문에 더 효율적입니다.


### 쿠키의 라이프타임
>쿠키의 라이프타임은 두 가지 방식으로 설정할 수 있습니다

1. 세션 쿠키
- 세션 쿠키는 브라우저가 종료될 때까지 존재합니다. 만약 브라우저가 종료되면 세션 쿠키는 자동으로 삭제됩니다.

2. 영속적인 쿠키
- 영속적인 쿠키는 Expires 혹은 Max-Age 속성을 사용해 만료 시간을 설정할 수 있습니다. 이 기간이 지나면 쿠키는 삭제됩니다.


### 보안 문제
쿠키는 주로 세션 하이재킹과 XSS(Cross-Site Scripting) 공격에 취약합니다. 악의적인 사용자는 쿠키를 가로채서 사용자 세션을 탈취할 수 있습니다. 이를 방지하려면 HttpOnly와 Secure 플래그를 사용하고 쿠키를 짧은 수명으로 설정하는 것이 좋습니다.

- 세션 하이재킹 방지
    - 쿠키를 전송하는 과정에서 악성 코드가 쿠키를 가로챌 수 있기 때문에 HTTPS 프로토콜을 사용하여 암호화된 통신을 유지해야 합니다.

- XSS 방지
    - XSS 공격은 악의적인 스크립트가 쿠키를 탈취하는 방식인데 이를 막기 위해 HttpOnly 쿠키를 사용하고 모든 입력값을 철저히 검증해야 합니다.

### Secure & HttpOnly 쿠키
> 쿠키는 웹 애플리케이션에서 중요한 역할을 하지만, 보안과 성능 측면에서 고려해야 할 점이 많습니다.

- Secure 쿠키
    - HTTPS 프로토콜에서만 전송되는 쿠키로 보안을 강화합니다. 그러나 민감한 정보를 쿠키에 저장하는 것은 여전히 위험합니다.
- HttpOnly 쿠키
    - JavaScript로 쿠키에 접근하지 못하도록 설정하여 XSS 공격을 방지하는 데 도움을 줍니다.


## 세션
> 이전 블로그에서 작성하였기에 생략하겠습니다.

세션은 서버 측에서 사용자의 상태를 저장하는 방식입니다. 사용자가 서버에 접속하면 서버는 고유한 세션 ID를 발급하고 이 세션 ID는 클라이언트의 쿠키에 저장됩니다. 이후 클라이언트가 서버로 요청을 보낼 때 세션 ID를 쿠키와 함께 전송하면 서버는 이 세션 ID를 바탕으로 사용자의 정보를 찾아 처리합니다.

## 세션 vs 쿠키
> 웹 애플리케이션에서의 상태 관리 기술 비교

웹 애플리케이션에서 상태 관리는 사용자의 정보를 기억하고 웹 사이트와의 상호작용을 원활하게 만드는 중요한 부분입니다. 이를 위해 **세션(Session)**과 **쿠키(Cookie)**가 주로 사용됩니다.

### 쿠키

**장점**
1. 클라이언트 측 저장 <br/>
쿠키는 브라우저에 저장되기 때문에 서버의 리소스를 절약할 수 있습니다.

2. 브라우저 간 상태 유지 <br/>
사용자가 브라우저를 닫거나 재시작해도 쿠키는 유효할 수 있기 때문에 사용자가 웹사이트에 돌아왔을 때 로그인 상태나 설정을 기억할 수 있습니다.

3. 데이터 유효 기간 설정 <br/>
쿠키는 만료 시간을 설정할 수 있어, 일정 기간 동안 정보를 유지할 수 있습니다.

**단점**
1. 보안 문제
민감한 정보는 쿠키에 저장해서는 안 됩니다. 쿠키는 XSS 공격이나 세션 하이재킹에 취약할 수 있습니다.

2. 용량 제한
쿠키의 크기는 브라우저마다 다르지만 보통 4KB 내외로 제한됩니다.

3. 성능 이슈
요청할 때마다 쿠키가 포함되기 때문에 성능에 영향을 줄 수 있습니다. 특히 모바일 환경에서는 네트워크 대역폭을 낭비할 수 있습니다.

### 세션

**장점**
1. 보안성 <br/>
세션 정보는 서버 측에 저장되므로 민감한 데이터가 클라이언트 측에 저장되지 않아 상대적으로 보안이 강화됩니다.

2. 용량에 제한 없음 <br/>
세션은 서버에서 데이터를 저장하므로 쿠키보다 많은 데이터를 저장할 수 있습니다.

3. 세션 만료 기능 <br/>
일정 시간 후 세션이 자동으로 만료되기 때문에 세션 하이재킹 위험을 줄일 수 있습니다.

**단점**
1. 서버 리소스 소모 <br/>
세션은 서버에 저장되므로 많은 사용자들이 접속하는 웹 애플리케이션에서는 서버의 메모리나 DB 리소스를 소모할 수 있습니다.

2. 상태 유지에 제한 <br/>
서버 측에 저장되기 때문에 사용자가 브라우저를 종료하거나 세션이 만료되면 상태 정보가 사라지게 됩니다.

3. 세션 관리 필요 <br/>
세션의 수명이나 관리 등을 적절히 처리하지 않으면 세션이 유효하지 않게 될 수 있습니다.


## 왜?

### 쿠키는 왜 보안과 성능 측면에서 고려할 게 많을까?
- **보안** <br/>
    쿠키는 클라이언트 측에 저장되기 때문에 악성 코드나 공격자에 의해 세션 하이재킹(사용자 쿠키 탈취)이 발생할 수 있습니다. 또한 XSS 공격을 통해 쿠키에 저장된 민감한 정보를 탈취할 수 있습니다. 이를 방지하려면 Secure와 HttpOnly 플래그를 사용하고 민감한 정보는 쿠키에 저장하지 않아야 합니다.

- **성능** <br/> 
    쿠키는 요청마다 서버로 **자동 전송**되기 때문에 특히 많은 데이터를 저장하면 네트워크 대역폭을 소모하고 성능에 영향을 미칠 수 있습니다. 이런 이유로 현대적인 웹 스토리지 API가 더 많이 사용됩니다.

### 세션도 쿠키와 연관되어 보안이 중요하지만 왜 세션은 상대적으로 안전한가?
세션은 서버 측에 정보를 저장하고 **세션 ID만** 클라이언트에 쿠키로 전달합니다. 이 세션 ID는 악성 코드가 가로챌 수 있지만 세션 정보 자체는 서버에 저장되어 있기 때문에 세션 하이재킹을 당하더라도 서버에서 세션을 무효화할 수 있는 여지가 있습니다. 또한, 서버 측에서 세션 만료와 세션 관리가 가능하므로 더 안전하게 관리할 수 있습니다.

### 웹 스토리지 API를 사용하더라도 서버에 요청하려면 토큰 같은걸 매번 header에 포함해야하는거 아닌가? 똑같으 성능 저하를 유발할 수 있는거 아닌가?
- 쿠키는 **자동으로** 요청에 포함되므로 매번 전송됩니다. 이로 인해 성능 저하가 발생할 수 있습니다. (특히 많은 양의 데이터를 저장하는 경우)
- 웹 스토리지는 자동으로 전송되지 않기 때문에 HTTP 요청 시 명시적으로 헤더에 포함해야 합니다. 이 과정에서 성능 저하는 발생하지 않습니다. 하지만, 헤더에 토큰을 매번 포함시키는 추가 작업이 필요할 수 있습니다.

**정리**
- 쿠키는 자동으로 요청에 포함되지만, 요청 시마다 전송되는 데이터가 많으면 성능 저하가 발생할 수 있다는 단점이 있습니다.
- 웹 스토리지는 성능 저하 문제를 줄일 수 있는 장점이 있지만 서버에 요청할 때 매번 HTTP 헤더에 데이터를 포함해야 하는 번거로움이 있습니다. 

성능 측면에서의 차이는 **자동 전송 여부**에 따라 달라지기 때문에 저장하는 **데이터의 크기**와 **필요한 전송 빈도**에 따라 적절한 선택을 하는 것이 중요합니다.


### 세션 + 인메모리 DB 세트?
(JWT를 세션 쿠키로 보내면?저장하면? 인메모리 DB, 즉 서버에서 저장안해도되지않나?)
-> 질문이 잘못됐다. JWT를 세션 쿠키로 보낸다는거는 세션을 100% 의도대로 사용하고 있지 않다는 것이다.

- 세션은 본래 서버 측에서 관리되는 상태 정보입니다. 사용자가 로그인하면 서버는 세션 ID를 생성하고 이 ID에 대응하는 정보를 DB나 Redis에 저장합니다. 클라이언트는 **세션 ID만 쿠키로** 받아서 요청 시 서버에 전송하고, 서버는 이 ID를 사용하여 세션 정보를 조회합니다.

- 만약 JWT를 세션 쿠키로 보내는 경우, JWT 토큰 자체를 클라이언트에 저장하게 되므로 세션이 제공하는 서버 측 상태 관리 기능을 사용하지 않게 됩니다. 즉, JWT 자체가 상태 없는(stateless) 인증 방식이기 때문에, 서버에서 별도로 세션을 저장하고 관리할 필요가 없어집니다. 이 경우, 서버는 JWT 토큰을 클라이언트 측에서 디코딩하여 정보를 얻고, 세션 정보 관리의 이점을 활용하지 않게 됩니다.

- 따라서, 세션을 사용하려면 JWT를 세션 쿠키로 보내지 말고, 세션 ID만을 쿠키로 보내는 방식으로 처리해야 합니다. 이 방식에서는 서버 측에서 세션 데이터를 관리하고, 세션 ID만을 클라이언트에게 전달하여 인증을 처리합니다.

