---
title: 3장 정리 - 완강
description: SQL의 조건 분기
# author: d_o0o_b
categories: [Reading, SQL-Level-Up]
tags: [typography]
# pin: true
math: true
mermaid: true
---

## 8강: UNION을 사용한 쓸데업이 긴 표현

SQL 초보자가 자주 사용하는 조건 분기 방식 중 하나가 바로 UNION이다.
일반적으로는 WHERE 절만 조금씩 다른 여러 개의 SELECT 구문을 UNION으로 합쳐서,
여러 조건에 맞는 결과를 하나의 집합으로 모으고자 할 때 사용한다.

이 방식은 문제를 작은 단위로 쪼개어 각각 처리한 뒤, 다시 합치는 구조이기 때문에
생각하기 쉽고 구현도 직관적이라는 장점이 있다.
그래서 조건 분기 문제를 처음 마주했을 때 가장 먼저 떠올릴 수 있는 접근법이기도 하다.

### UNION을 사용했을 때의 실행 계획 문제

겉보기엔 하나의 SQL 구문처럼 보이지만, 실제로는 여러 개의 SELECT 문을 따로 실행하게 된다.
이는 곧 실행 계획상 테이블 접근 횟수가 늘어나고,
그에 따라 I/O 비용도 함께 증가한다는 뜻이다.

특히 TABLE ACCESS FULL이 발생하면
테이블의 크기에 따라 읽는 비용이 선형적으로 증가하게 되므로
데이터량이 많아질수록 성능 저하가 심각해질 수 있다.


### 정확한 판단 없는 UNION 사용 회피

UNION은 정말 편리한 도구다.
복잡한 조건도 쉽게 나눠서 처리할 수 있다는 점에서 유혹을 느끼기 쉽다.
하지만 조건 분기를 위해 SELECT 문 전체를 반복해 작성하는 것은
불필요한 테이블 접근을 만들고,
SQL 성능을 떨어뜨리는 원인이 될 수 있다.

또한 이는 물리적인 리소스인 저장소의 I/O 비용까지 낭비하게 만든다.
즉, 가독성도 낮고, 성능도 나쁜 코드가 된다.

### WHERE 구에서 조건 분기를 하는 사람은 초보자 ⭐️
>"조건 분기를 WHERE 구로 하는 사람들은 초보자다. 잘 하는 사람은 SELECT 구만으로 조건 분기를 한다"

SQL에서는 CASE 식을 활용해 SELECT 내부에서 조건 분기를 할 수 있다.
이 방식을 사용하면 구문을 반복하지 않고도 조건을 표현할 수 있다.
즉, 하나의 SELECT 문 안에서 다양한 조건에 따른 값을 유연하게 다룰 수 있다는 뜻이다.


### SELECT 구를 사용한 조건 분기의 실행 계획
UNION을 활용한 조건 분기는 SELECT '구문' 자체를 분기하는 접근이다.
이 방식은 아직 절차 지향적 사고에 기반한 방법이라고 볼 수 있다.
반면, CASE 식을 활용한 조건 분기는 '식'을 중심으로 사고하는 방식이다.
즉, 선언적이고 SQL 본연의 철학에 가까운 접근이라 할 수 있다.

SQL을 잘 다루기 위해서는
이처럼 '구문'에서 '식' 중심의 사고로 전환하는 것이 핵심이다.
이는 SQL을 마스터하기 위한 중요한 전환점이기도 하다.

### 마무리
UNION은 잘만 쓰면 유용하지만,
무분별한 사용은 성능 저하와 유지보수의 어려움을 불러온다.

조건 분기가 필요할 때,
무작정 UNION을 사용할 것이 아니라
CASE 식으로 SELECT 안에서 분기할 수 있는지 먼저 고민하는 습관을 들여야 한다.

<br/>
<br/>

## 10장: 그래도 UNION이 필요한 경우
지금까지는 UNION의 남용이 SQL 성능에 악영향을 줄 수 있음을 강조해왔다.
하지만 언제나 예외는 존재한다. 실제로 UNION이 불가피한 상황도 있고, 오히려 성능상 유리한 경우도 있다.


### UNION을 사용할 수 밖에 없는 경우
대표적인 경우는 SELECT 구문들이 서로 다른 테이블을 사용하는 경우이다.
즉, 여러 테이블의 결과를 하나로 합쳐야 할 때는 UNION이 가장 자연스러운 선택이다.

CASE 식을 사용하고 싶다면 FROM 절에서 테이블을 조인하여 처리할 수도 있다.
하지만 이렇게 불필요한 조인을 발생시키면 쿼리의 복잡도와 성능 비용이 커지게 된다.
반면, UNION은 필요한 결과만 깔끔히 합칠 수 있기 때문에 더 효율적일 수 있다.

이처럼 실행 계획을 분석해서, 불필요한 결합을 피하고 성능을 고려한 판단이 필요하다.


### UNION을 사용하는 것이 성능적으로 더 좋은 경우
CASE 식이나 다른 대안으로도 구현 가능하지만,
UNION이 인덱스를 더 잘 활용할 수 있는 구조라면 오히려 성능상 이점이 있다.

특히 다음과 같은 상황을 주의 깊게 보아야 한다.

#### 1. OR 조건을 사용할 때
WHERE 절에 OR 조건을 사용하는 경우,
대부분의 DB는 해당 컬럼에 인덱스를 사용하지 못하고 풀 테이블 스캔을 하게 된다.
이 경우 SELECT 문을 분리해서 UNION으로 처리하면
각 SELECT 문이 인덱스를 활용할 수 있게 된다.

즉, OR을 사용할 때보다 UNION을 사용할 때 레코드 탐색 속도가 빨라질 수 있다.
다만 이는 테이블 크기, 인덱스 구성, 조건 선택도에 따라 달라지므로 실행 계획 확인은 필수다.


#### 2. IN 조건을 사용할 때
IN 조건도 OR과 마찬가지로 실행 계획이 비슷하게 나온다.
따라서 인덱스를 충분히 활용하지 못하는 구조라면
UNION이 더 효율적일 수 있다.


## 정리하자면
UNION은 무조건 지양해야 할 대상이 아니다.
다만, 필요에 따라 사용하는 '선택지' 중 하나일 뿐이며,
사용할 타이밍과 이유에 대한 근거가 있어야 한다는 점이 중요하다.


<br/>
<br/>


## 11장: 절차 지향형과 선언형 사고
UNION이 조건 분기를 위한 수단으로 만들어진 것이 아니기에
CASE 식에 비해 성능과 가독성 모두에서 부족한 점이 많다.
CASE 식은 조건 분기를 목적으로 설계된 도구이기 때문에 훨씬 자연스럽다.


### 구문 기반 사고 vs 식 기반 사고
CASE 식이 처음에는 어렵게 느껴질 수 있다.
그 이유는 초보자와 중급자 이상 개발자의 사고 체계 자체가 다르기 때문이다.

초보자는 절차 지향형 사고에 익숙하다.
이들은 일반적인 프로그래밍 언어에서처럼 '구문(statement)'을 중심으로 사고한다.

반면 중급자 이상은 선언형 사고에 익숙하다.
이들은 SQL의 기본 단위인 '식(expression)'을 중심으로 사고한다.

### UNION은 절차 지향형 방식이다
UNION은 여러 SELECT 문을 구문 단위로 연결한다.
이는 명령의 순서를 따라가는 절차 지향적 방식으로, 프로그래밍에 익숙한 사람들에게 자연스럽게 다가온다.
그래서 초보자일수록 조건 분기에 UNION을 사용하려는 경향이 강하다.

하지만 SQL의 철학은 선언형이다.
SQL에서는 CASE 구문이 아니라 CASE 식을 사용한다.
즉, SQL에서는 구문이 아니라 식을 중심으로 사고하고 작성해야 한다.

### 마무리
CASE 식을 사용한 분기는
SQL의 선언형 사고방식에 맞는, 성능과 가독성을 모두 만족하는 방법이다.

UNION은 특정 상황에서는 반드시 필요하거나 더 효율적일 수 있다.
그러나 그 사용이 습관적으로 반복된다면,
이는 절차 지향적 사고에 갇혀 있다는 신호일 수 있다.

SQL을 잘 다루기 위해서는
절차 지향적 사고에서 선언형 사고로 넘어가는 전환이 꼭 필요하다.
이는 단순히 문법을 배우는 것이 아닌, SQL이라는 언어의 철학을 이해하는 과정이다.
